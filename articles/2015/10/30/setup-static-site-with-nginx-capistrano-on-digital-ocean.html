<!DOCTYPE html><html ng-app="kagd"><head><script src="https://use.typekit.net/ola6uac.js"></script><script>try{Typekit.load({ async: true });}catch(e){}</script><meta charset="utf-8" /><meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><title>Grant R. Klinsing  - Setup static site with Nginx & Capistrano on Digital Ocean</title><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/articles/feed.xml" /><link href="/stylesheets/application.css" rel="stylesheet" /><link href="/stylesheets/syntax_highlighter/monokai.css" rel="stylesheet" /><link href="/images/favicon.ico" rel="icon" type="image/ico" /><script src="/javascripts/vendor.js"></script></head><body class="articles articles_2015 articles_2015_10 articles_2015_10_30 articles_2015_10_30_setup-static-site-with-nginx-capistrano-on-digital-ocean" menu-classes=""><div class="grid-frame"><div class="grid-block vertical"><div class="grid-block shrink"><header class="title-bar dark"><div class="title left"><a class="brand" href="/"><img alt="Grant Klinsing" src="/images/logo.svg" /></a></div><div class="right"><nav><ul><li class="menu"><a menu-button=""><span>Menu</span><div class="bars"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div></a></li><li class="articles"><a href="/posts.html"><i class="fa fa-book"></i><span>/ Articles</span></a></li><li class="github"><a href="http://github.com/kagd" target="_blank"><i class="fa fa-github"></i><span>/ kagd</span></a></li><li class="twitter"><a href="http://twitter.com/gklinsing" target="_blank"><i class="fa fa-twitter"></i><span>/ @gklinsing</span></a></li><li class="stack-overflow"><a href="http://careers.stackoverflow.com/gklinsing" target="_blank"><i class="fa fa-stack-overflow"></i><span>/ gklinsing</span></a></li><li class="linked-in"><a href="https://www.linkedin.com/in/grantklinsing" target="_blank"><i class="fa fa-linkedin"></i><span>/ grantklinsing</span></a></li></ul></nav></div></header></div><section class="grid-block" id="main" role="main"><div class="grid-block align-center"><div class="grid-content large-8 article-content"><div class="article-header"><a class="tag" href="/articles/tags/nginx.html"><img src="/images/nginx.svg" /></a><h1>Setup static site with Nginx & Capistrano on Digital Ocean</h1><div class="date"> <span>2015 /</span>  <span>October 30</span> </div><hr /><div><strong>Article References:</strong> <a target="_blank" href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-14-04">Reference 1</a> <a target="_blank" href=" https://www.digitalocean.com/community/tutorials/deploying-a-rails-app-on-ubuntu-14-04-with-capistrano-nginx-and-puma">Reference 2</a></div></div><div class="article-body"><p>Setting up a static site on Digital Ocean is pretty simple. First we will create a
user that will run the Capistrano deployment. Then, setup SSH, install Nginx, and
finally run Capistrano. Let&rsquo;s get started!</p>

<p></p>

<p><strong>Note:</strong> All commands should be run as root unless specified. The Digital Ocean
instance setup here is for Ubuntu.</p>

<h1>Setup Deploy User</h1>

<p>First let&rsquo;s SSH into the Digital Ocean server and add a new user called <em>deploy</em>.</p>

<pre><code class="prettyprint lang-bash">adduser deploy
</code></pre>

<p>Then to add your new user to the sudo group</p>

<pre><code class="prettyprint lang-bash">gpasswd -a deploy sudo
</code></pre>

<p>Now the <em>deploy</em> user can run commands with super user privileges!</p>

<p>Switch to new user for the following commands</p>

<pre><code class="prettyprint lang-bash">su - deploy
</code></pre>

<h1>Setup SSH as the deploy user</h1>

<p>Create a new directory called .ssh and restrict its permissions with the following commands:</p>

<pre><code class="prettyprint lang-bash">mkdir .ssh
# set permissions so deploy can read, write and execute
chmod 700 .ssh
nano .ssh/authorized_keys
</code></pre>

<p>From your local machine, copy your public key <code class="prettyprint">pbcopy &lt; ~/.ssh/id_rsa.pub</code>,
and then paste it into <em>authorized_keys</em>. Save and close.</p>

<p>Now restrict the permissions of the authorized_keys file with this command:</p>

<pre><code class="prettyprint lang-bash">chmod 600 .ssh/authorized_keys
</code></pre>

<p>You will now be able to SSH into your server as the <em>deploy</em> user.</p>

<h1>Generate a server public key from Capistrano deployment</h1>

<p>On the server run <code class="prettyprint">ssh-keygen -t rsa</code> and follow the prompts.</p>

<p>Then add the server key to your git repo host (github, bitbucket, etc) deployment keys.</p>

<p><code class="prettyprint">cat ~/.ssh/id_rsa.pub</code> will display the public key.</p>

<h1>Install Nginx</h1>

<p>Update out-of-date packages</p>

<pre><code class="prettyprint lang-bash">sudo apt-get update
</code></pre>

<p>Then, install Nginx:</p>

<pre><code class="prettyprint lang-bash">sudo apt-get install curl git-core nginx
</code></pre>

<h1>Configure Nginx to run the site</h1>

<p>Create a file named <em>static_site</em> under Nginx</p>

<pre><code class="prettyprint lang-bash">cd /etc/nginx/sites-available
nano static_site
</code></pre>

<p>Then add this config to the file</p>

<pre><code class="prettyprint">server {
  root /var/www/static_site/current;
}
</code></pre>

<p><code class="prettyprint">/var/www/static_site/current</code> is the path where the site files will live. We
will manually create the <em>static_site</em> directory later and Capistrano will create
the <em>current</em> directory during deployment.</p>

<p>Next, we will enable the site and remove the default Nginx config.</p>

<pre><code class="prettyprint lang-bash">cd ../sites-enabled
ln -s ../sites-available/static_site static_site
rm default
</code></pre>

<p>And, create the base directory for the site files and change permissions to
be owned by deploy.</p>

<pre><code class="prettyprint lang-bash">mkdir /var/www/static_site
chown deploy /var/www/static_site
</code></pre>

<h1>Capistrano</h1>

<p>Add Capistrano to you Gemfile</p>

<pre><code class="prettyprint lang-rb">gem &#39;capistrano&#39;, &#39;~&gt; 3.4.0&#39;
</code></pre>

<p>and run</p>

<pre><code class="prettyprint lang-bash">bundle install
</code></pre>

<p>Capistrano needs a couple of directories and files so let&rsquo;s run</p>

<pre><code class="prettyprint lang-bash">cap install
</code></pre>

<p>Add the following to the generated <code class="prettyprint">deploy.rb</code> file, remembering to update the repo_url.</p>

<pre><code class="prettyprint lang-rb"># deploy.rb
# config valid Capistrano 3.4.x
lock &#39;3.4.0&#39;

set :application,   &#39;static_site&#39;
set :repo_url,      &#39;git@&lt;repoUrlHere&gt;&#39;
set :scm,           :git
set :user,          &quot;deploy&quot;
set :pty,           true
</code></pre>

<p>Copy this to your <code class="prettyprint">production.rb</code> file and update the server IP address.</p>

<pre><code class="prettyprint lang-rb"># production.rb
set :application, &#39;static_site&#39;

## Servers we are going to deploy to ----------------------
server &#39;xxx.xxx.xxx.xxx&#39;, user: &#39;deploy&#39;

## Server Settings ----------------------------------------
set :deploy_to, &quot;/var/www/static_site&quot;

## Git Configuration Settings -----------------------------
set :branch, &quot;master&quot; # set to your desired branch
</code></pre>

<h2>Test out Capistrano</h2>

<p>Check if necessary files and directories exist. If they don&rsquo;t, Capistrano will create
them.</p>

<pre><code class="prettyprint lang-bash">bundle exec cap production deploy:check
</code></pre>

<h2>Deploy your App</h2>

<pre><code class="prettyprint lang-bash">bundle exec cap production deploy
</code></pre>
<hr /><div class="article-links"><h5>Article Links</h5><div><a class="btn btn-primary" target="_blank" href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-14-04">Reference 1</a> <a class="btn btn-primary" target="_blank" href=" https://www.digitalocean.com/community/tutorials/deploying-a-rails-app-on-ubuntu-14-04-with-capistrano-nginx-and-puma">Reference 2</a></div></div><div id="disqus_thread"></div><script>/* * * CONFIGURATION VARIABLES * * */
var disqus_shortname = 'kagdgithubio';
var disqus_identifier = 'setup-static-site-with-nginx-capistrano-on-digital-ocean';
var disqus_title = 'Setup static site with Nginx & Capistrano on Digital Ocean';
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div></div></section></div></div><div class="mobile-menu"><ul><li class="articles"><a href="/posts.html"><i class="fa fa-book"></i><span>/ Articles</span></a></li><li class="github"><a href="http://github.com/kagd" target="_blank"><i class="fa fa-github"></i><span>/ kagd</span></a></li><li class="twitter"><a href="http://twitter.com/gklinsing" target="_blank"><i class="fa fa-twitter"></i><span>/ @gklinsing</span></a></li><li class="stack-overflow"><a href="http://careers.stackoverflow.com/gklinsing" target="_blank"><i class="fa fa-stack-overflow"></i><span>/ gklinsing</span></a></li><li class="linked-in"><a href="https://www.linkedin.com/in/grantklinsing" target="_blank"><i class="fa fa-linkedin"></i><span>/ grantklinsing</span></a></li></ul></div><script src="/javascripts/application.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-67203020-1', 'auto');
ga('send', 'pageview');</script></body></html>