<!DOCTYPE html><html ng-app="kagd"><head><script src="https://use.typekit.net/ola6uac.js"></script><script>try{Typekit.load({ async: true });}catch(e){}</script><meta charset="utf-8" /><meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><title>Grant Klinsing  - Rails Form Objects</title><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/articles/feed.xml" /><link href="/stylesheets/application-6f31c7ce.css" rel="stylesheet" /><link href="/stylesheets/syntax_highlighter/monokai-087b6249.css" rel="stylesheet" /><link href="/images/favicon.ico" rel="icon" type="image/ico" /><script>window.env = {
  API_HOST: '/'
}</script><script src="/javascripts/vendor-27cf58e5.js"></script></head><body class="articles articles_2015 articles_2015_09 articles_2015_09_04 articles_2015_09_04_rails-form-objects" menu-classes=""><div class="grid-frame"><div class="grid-block vertical"><div class="grid-block shrink"><header class="title-bar dark"><div class="title left"><a class="brand" href="/"><img alt="Grant Klinsing" src="/images/logo-a84e8d17.svg" /></a></div><div class="right"><nav><ul><li class="menu"><a menu-button=""><span>Menu</span><div class="bars"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div></a></li><li class="articles"><a href="/posts.html"><i class="fa fa-book"></i><span>/ Articles</span></a></li><li class="github"><a href="http://github.com/kagd" target="_blank"><i class="fa fa-github"></i><span>/ kagd</span></a></li><li class="twitter"><a href="http://twitter.com/gklinsing" target="_blank"><i class="fa fa-twitter"></i><span>/ @gklinsing</span></a></li><li class="stack-overflow"><a href="http://careers.stackoverflow.com/gklinsing" target="_blank"><i class="fa fa-stack-overflow"></i><span>/ gklinsing</span></a></li><li class="linked-in"><a href="https://www.linkedin.com/in/grantklinsing" target="_blank"><i class="fa fa-linkedin"></i><span>/ grantklinsing</span></a></li></ul></nav></div></header></div><section class="grid-block" id="main" role="main"><div class="grid-block align-center"><div class="grid-content large-8 article-content"><div class="article-header"><a class="tag" href="/articles/tags/rails.html"><img src="/images/rails-876afa14.svg" /></a><h1>Rails Form Objects</h1><div class="date"> <span>2015 /</span>  <span>September 4</span> </div></div><div class="article-body"><p>Form objects are a pretty simple. If you are familiar with ActiveRecord models, then you
can work with form objects. Essentially, a form object is a non-persisted model. They
allow you to run validations on specific properties of a separate, persisted model.</p>

<p></p>

<h2>Why should I use a form object?</h2>

<p>Form objects are a great solution when you have a model that has a bunch of if/else
logic on validations. For instance, if you have an admin section that allows for
the creation of a <code class="prettyprint">User</code> model. Here is that model:</p>

<pre><code class="prettyprint lang-rb"># located /app/models/user.rb
class User &lt; ActiveRecord::Base
  validates :first_name,
            :last_name,
            :phone_number,
            :email,
            :password,
            :password_confirmation,
            presence: true
end
</code></pre>

<p>The admin can create the entire user so all of the validations should be run on save.</p>

<p>Now, let&rsquo;s assume that there are non-admins that can update an user but don&rsquo;t have the
rights to change emails and passwords. You could do something like:</p>

<pre><code class="prettyprint lang-rb"># located /app/models/user.rb
class User &lt; ActiveRecord::Base
  attr_accessor :admin_update
  validates :email,
            :password,
            :password_confirmation,
            presence: true,
            if: Proc.new{ admin_update == true  }

  validates :first_name,
            :last_name,
            :phone_number
            presence: true
end
</code></pre>

<p>We added an <code class="prettyprint">attr_accessor</code> to create a non-persisted property that we check each time
to require <code class="prettyprint">:email</code>, <code class="prettyprint">:password</code> and <code class="prettyprint">:password_confirmation</code> if being updated by an admin.</p>

<p>There are two down side here. You have now created logic in your base model that has nothing
to do with the model itself. It has to do with your business logic. And, you now
have to do this <code class="prettyprint">user.admin_update = true</code> in any section updating the user by an admin.
This may be a bad example since email and password is typically only updated in one or
two spots anyway, but you can see my point.</p>

<h2>Get to the Form Ojects Already!</h2>

<p>So, rather than creating a bunch of spaghetti logic within your models, use a form object.
Non-admins can only update <code class="prettyprint">:first_name</code>, <code class="prettyprint">:last_name</code>, and <code class="prettyprint">:phone_number</code>, so those
are the only attributes within the form object.</p>

<pre><code class="prettyprint lang-rb"># located /app/forms/user.rb
module Forms
  class User
    include ActiveModel::Model

    attr_accessor :first_name, :last_name, :phone_number
    validates :first_name, :last_name, :phone_number, presence: true
    validates :phone_number,
              length: {
                is: 10
              },
              numericality: {
                only_integer: true
              }

    def initialize(attrs={})
      attrs.each do |key, value|
        send(&quot;#{key}=&quot;, value)
      end
    end

    def attributes
      {
        first_name: first_name,
        last_name: last_name,
        phone_number: phone_number
      }
    end

    def save_to(user)
      if valid?
        user.assign_attributes attributes
        user.save validate: false
      else
        false
      end
    end
  end
end

</code></pre>

<p>There is a little bit that we should go over here.</p>

<p>First, we just set up a simple Ruby object and include <code class="prettyprint">ActiveModel::Model</code>. This
is what give us our validations.</p>

<p>Next we setup our non-persisted attributes with <code class="prettyprint">attr_accessor</code>. After that, a few
validations. Both of which should look familiar to you if you work with Rails.</p>

<p><code class="prettyprint">initialize</code> is just iterating over each attribute passed in and setting it on the
form object. This is similar to how <code class="prettyprint">User.build</code> works. Here is an example:</p>

<pre><code class="prettyprint lang-rb">user = User.find params[:id]
form = Forms::User.new first_name: user.first_name, last_name: user.last_name
</code></pre>

<p>Unfortunately, since we are just using <code class="prettyprint">attr_accessor</code> we don&rsquo;t have anyway to
get the collection of attributes as a hash. So we have to define the attributes
method.</p>

<p>And finally, <code class="prettyprint">save_to</code> allows us to save our valid form object back to the parent
user. Notice we use <code class="prettyprint">validate: false</code> because we don&rsquo;t want to trigger an email
validation when the current non-admin can&rsquo;t do anything about it.</p>

<h2>Examples</h2>

<pre><code class="prettyprint lang-rb">user = User.find params[:id]
form = Forms::User.new phone_number: &#39;5555555555&#39;
form.save_to user #=&gt; false
form.errors #=&gt; #&lt;ActiveModel::Errors:0x007fd5c8814020 @base=#&lt;Forms::User:0x007fd5c884cc90 @phone_number=&quot;5555555555&quot;, @validation_context=nil, @errors=#&lt;ActiveModel::Errors:0x007fd5c8814020 ...&gt;&gt;, @messages={:first_name=&gt;[&quot;can&#39;t be blank&quot;], :last_name=&gt;[&quot;can&#39;t be blank&quot;]}&gt;
form.first_name = &#39;Grant&#39;
form.last_name = &#39;Klinsing&#39;
form.valid? #=&gt; true
form.save_to user #=&gt; true
user.first_name #=&gt; &quot;Grant&quot;
</code></pre>

<h2>Validation Callbacks</h2>

<p>In most cases you will only need to add <code class="prettyprint">include ActiveModel::Model</code>.
If you would like to run <code class="prettyprint">before_validation</code> and/or <code class="prettyprint">after_validation</code> just include
<code class="prettyprint">ActiveModel::Validations::Callbacks</code> after <code class="prettyprint">include ActiveModel::Model</code>.</p>

<pre><code class="prettyprint lang-rb"># located /app/forms/user.rb
module Forms
  class User
    include ActiveModel::Model
    include ActiveModel::Validations::Callbacks
    #...
    before_validation :clean_phone_number
    #...

    private #-------------------------------------------------------

    def clean_phone_number
      @phone_number = @phone_number.scan(/\d+/).join(&#39;&#39;)
    end
  end
end

</code></pre>

<p>Now our <code class="prettyprint">clean_phone_number</code> method allow phone_number to only be validated against
the numbers so our numericality check will not fail.</p>
<div id="disqus_thread"></div><script>/* * * CONFIGURATION VARIABLES * * */
var disqus_shortname = 'kagdgithubio';
var disqus_identifier = 'rails-form-objects';
var disqus_title = 'Rails Form Objects';
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div></div></section></div></div><div class="mobile-menu"><ul><li class="articles"><a href="/posts.html"><i class="fa fa-book"></i><span>/ Articles</span></a></li><li class="github"><a href="http://github.com/kagd" target="_blank"><i class="fa fa-github"></i><span>/ kagd</span></a></li><li class="twitter"><a href="http://twitter.com/gklinsing" target="_blank"><i class="fa fa-twitter"></i><span>/ @gklinsing</span></a></li><li class="stack-overflow"><a href="http://careers.stackoverflow.com/gklinsing" target="_blank"><i class="fa fa-stack-overflow"></i><span>/ gklinsing</span></a></li><li class="linked-in"><a href="https://www.linkedin.com/in/grantklinsing" target="_blank"><i class="fa fa-linkedin"></i><span>/ grantklinsing</span></a></li></ul></div><script src="/javascripts/application-554388e2.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-67203020-1', 'auto');
ga('send', 'pageview');</script></body></html>